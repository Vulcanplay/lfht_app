!function(t,i){"object"==typeof exports&&"undefined"!=typeof module?module.exports=i():"function"==typeof define&&define.amd?define(i):t.MCanvas=i()}(this,function(){"use strict";function t(i,e,o){if(!(this instanceof t))return new t(i,e,o);this.ops={width:i||500,height:e||i,backgroundColor:o},this.canvas=null,this.ctx=null,this.queue=[],this.end=null,this.textData={},this.bgConfig=null,this._init()}var i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},e={extend:function(t,e){for(var o in e)e.hasOwnProperty(o)&&("object"==i(e[o])?("object"===i(t[o])&&null!==t[o]||(t[o]={}),this.extend(t[o],e[o])):t[o]=e[o]);return t},loadImage:function(t,i,e){var o=new Image;0==t.indexOf("http")&&(o.crossOrigin="*"),o.onload=function(){i(o)},o.onerror=function(){e("img load error")},o.src=t},isArr:function(t){return"[object Array]"===Object.prototype.toString.call(t)},getImage:function(t,e){if("string"==typeof t)this.loadImage(t,function(t){e(t)},function(t){console.log(t)});else{if("object"!=(void 0===t?"undefined":i(t)))return void console.log("add image error");e(t)}},forin:function(t,i){for(var e in t)t.hasOwnProperty(e)&&i(e,t[e])},isIos8:function(){var t=window.navigator.userAgent.toLowerCase(),i=/(iPhone|iPad|iPod|iOS)/gi.test(t),e=/(iPad)/gi.test(t);return!!i&&(e?t.match(/cpu os (\d*)/)[1]<9:t.match(/iphone os (\d*)/)[1]<9)}},o=function(){function t(t,i){var e=[],o=!0,n=!1,a=void 0;try{for(var r,h=t[Symbol.iterator]();!(o=(r=h.next()).done)&&(e.push(r.value),!i||e.length!==i);o=!0);}catch(t){n=!0,a=t}finally{try{!o&&h.return&&h.return()}finally{if(n)throw a}}return e}return function(i,e){if(Array.isArray(i))return i;if(Symbol.iterator in Object(i))return t(i,e);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}();return t.prototype._init=function(){this.canvas=document.createElement("canvas"),this.canvas.width=this.ops.width,this.canvas.height=this.ops.height,this.ctx=this.canvas.getContext("2d"),this.ops.backgroundColor&&(this.ctx.fillStyle=this.ops.backgroundColor,this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height))},t.prototype.background=function(t,i){var o=this;if(i||t)i.image=t,this.bgConfig=i;else{if(!this.bgConfig)return void console.error("mcanvas error : the init background must has the bg option params.");i=this.bgConfig}return this.queue.push(function(){i.color&&(o.ctx.fillStyle=i.color,o.ctx.fillRect(0,0,o.canvas.width,o.canvas.height)),i.image?e.getImage(i.image,function(t){o._background(t,i)}):console.error("mcanvas error : background image error!")}),this},t.prototype._getBgAlign=function(t,i,e,o){var n=void 0;return"string"==typeof t?"50%"==t||"center"==t?n=Math.abs((i-e/o)/2):"100%"==t?n=Math.abs(i-e/o):"0%"==t&&(n=0):n="number"==typeof t?t:0,n},t.prototype._background=function(t,i){var e=this._getSize(t),o=e.iw,n=e.ih,a=o/n,r=this.canvas.width/this.canvas.height,h=void 0,s=void 0,c=void 0,d=void 0,l=void 0,p=void 0,g=void 0,u=void 0,f=void 0;switch(i.type){case"crop":a>r?(c=n*r,d=n,f=this.canvas.height/n):(c=o,d=c/r,f=this.canvas.width/o),h=this._getBgAlign(i.left,o,this.canvas.width,f),s=this._getBgAlign(i.top,n,this.canvas.height,f),p=l=0,u=this.canvas.height,g=this.canvas.width;break;case"contain":s=h=0,c=o,d=n,a>r?(g=this.canvas.width,u=g/a,l=i.left||0,p=i.top||0==i.top?i.top:(this.canvas.height-u)/2):(u=this.canvas.height,g=u*a,p=i.top||0,l=i.left||0==i.left?i.left:(this.canvas.width-g)/2);break;case"origin":this.canvas.width=o,this.canvas.height=n,h=s=0,c=o,d=n,l=p=0,g=this.canvas.width,u=this.canvas.height;break;default:console.error("mcanvas error:background type error!")}this.ctx.drawImage(t,h,s,c,d,l,p,g,u),this._next()},t.prototype.watermark=function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",i=arguments[1];if(!t)return void console.error("mcanvas error : there is not image of watermark.");var e=i.width,o=void 0===e?"40%":e,n=i.pos,a=void 0===n?"rightbottom":n,r=i.margin,h=void 0===r?20:r,s={x:0,y:0,scale:1,rotate:0};switch(a){case"leftTop":s.x="left:"+h,s.y="top:"+h;break;case"leftBottom":s.x="left:"+h,s.y="bottom:"+h;break;case"rightTop":s.x="right:"+h,s.y="top:"+h;break;case"rightBottom":s.x="right:"+h,s.y="bottom:"+h}return this.add(t,{width:o,pos:s}),this},t.prototype.add=function(){var t=this,i=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",o=arguments[1],n={width:"100%",crop:{x:0,y:0,width:"100%",height:"100%"},pos:{x:0,y:0,scale:1,rotate:0}};return e.isArr(i)||(i=[{image:i,options:o}]),i.forEach(function(i){t.queue.push(function(){e.getImage(i.image,function(o){t._add(o,t._handleOps(e.extend(n,i.options),o))})})}),this},t.prototype._add=function(t,i){0==i.width&&console.warn("mcanvas warn: the width of mc-element is zero");var n=this._getSize(t),a=n.iw,r=n.ih,h=void 0,s=void 0,c=void 0,d=void 0,l=i.crop,p=l.x,g=l.y,u=l.width,f=l.height,v=u/f,y=void 0,x=void 0,w=void 0,m=void 0,b=document.createElement("canvas"),_=b.getContext("2d"),S=a>r?a/r:r/a,k=1.4*S>5?5:1.4*S,I=void 0,O=void 0;b.width=u*k,b.height=f*k;var A=void 0;if(e.isIos8()&&(b.width>2096||b.height>2096)?A=v>1?2096/b.width:2096/b.height:(b.width>4096||b.height>4096)&&(A=v>1?4096/b.width:4096/b.height),y=-Math.round(u/2),x=-Math.round(f/2),w=u,m=Math.round(u/v),A){var C=[b.width,b.height,y,x,w,m].map(function(t){return Math.round(t*A)}),M=o(C,6);b.width=M[0],b.height=M[1],y=M[2],x=M[3],w=M[4],m=M[5]}_.translate(b.width/2,b.height/2),_.rotate(i.pos.rotate),_.drawImage(t,p,g,u,f,y,x,w,m),c=i.width*k,d=c/v,I=(k-1)*i.width/2,O=I/v,h=i.pos.x+c*(1-i.pos.scale)/2-I,s=i.pos.y+d*(1-i.pos.scale)/2-O,c*=i.pos.scale,d*=i.pos.scale,this.ctx.drawImage(b,h,s,c,d),b=_=null,this._next()},t.prototype._getSize=function(t){var i=void 0,e=void 0;return"IMG"===t.tagName?(i=t.naturalWidth,e=t.naturalHeight):"CANVAS"===t.tagName?(i=t.width,e=t.height):(i=t.offsetWidth,e=t.offsetHeight),{iw:i,ih:e}},t.prototype._handleOps=function(t,i){var e=this.canvas.width,o=this.canvas.height,n=this._getSize(i),a=n.iw,r=n.ih,h=a/r,s=this._get(e,a,t.width,"pos"),c=void 0,d=void 0,l=t.crop,p=l.x,g=l.y,u=l.width,f=l.height,v={};v.width=this._get(e,a,u,"crop"),v.height=this._get(o,r,f,"crop"),v.x=this._get(a,v.width,p,"crop"),v.y=this._get(r,v.height,g,"crop"),v.x>a&&(v.x=a),v.y>r&&(v.y=r),c=a-v.x,d=r-v.y,v.width>c&&(v.width=c),v.height>d&&(v.height=d);var y=t.pos,x=y.x,w=y.y,m=y.rotate,b=y.scale;return{width:s,crop:v,pos:{x:this._get(e,s,x,"pos"),y:this._get(o,s/h,w,"pos"),scale:b,rotate:parseFloat(m)*Math.PI/180}}},t.prototype.text=function(){var t=this,i=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",o=arguments[1],n="helvetica neue,hiragino sans gb,Microsoft YaHei,arial,tahoma,sans-serif",a=this.canvas.width/20;return this.queue.push(function(){var r={width:300,align:"left",smallStyle:{font:.8*a+"px "+n,color:"#000",lineheight:.9*a},normalStyle:{font:a+"px "+n,color:"#000",lineheight:1.1*a},largeStyle:{font:1.3*a+"px "+n,color:"#000",lineheight:1.4*a},pos:{x:0,y:0}};r=e.extend(r,o),t._text(t._parse(i),r),t._next()}),this},t.prototype._parse=function(t){for(var i=t.split(/<s>|<b>/),e=[],o=0;o<i.length;o++){var n=i[o];if(/<\/s>|<\/b>/.test(n)){var a=/<\/s>/.test(n)?"</s>":"</b>",r=/<\/s>/.test(n)?"small":"large",h=i[o].split(a);e.push({type:r,text:h[0]}),h[1]&&e.push({type:"normal",text:h[1]})}else i[o]&&e.push({text:i[o],type:"normal"})}return e},t.prototype._text=function(t,i){var o=this;i.width=this._get(this.canvas.width,0,i.width,"pos");var n=void 0,a=1,r=0,h=function(t,i){var e=0,o=void 0;return t.forEach(function(t){(o=i[t.type+"Style"].lineheight)>e&&(e=o)}),e}(t,i),s=this._get(this.canvas.width,i.width,i.pos.x,"pos"),c=this._get(this.canvas.height,0,i.pos.y,"pos")+h;this.textData[a]={data:[],lineWidth:0},t.forEach(function(t){n=i[t.type+"Style"],o.ctx.font=n.font;var e=o.ctx.measureText(t.text).width,d=t.text.replace(/<br>/g,"|");if(r+e>i.width||-1!==d.indexOf("|"))for(var l=0,p=d.length;l<p;l++){var g=d[l];e=o.ctx.measureText(g).width,(r+e>i.width||"|"==g)&&(r=0,s=o._get(o.canvas.width,i.width,i.pos.x,"pos"),c+=h,a+=1,o.textData[a]={data:[],lineWidth:0},"|"==g)||(o.textData[a].data.push({context:g,x:s,y:c,style:n,width:e}),r+=e,s+=e,o.textData[a].lineWidth=r)}else o.textData[a].data.push({context:d,x:s,y:c,style:n,width:e}),r+=e,s+=e,o.textData[a].lineWidth=r}),e.forin(this.textData,function(t,e){var n=0;e.lineWidth<i.width&&("center"==i.align?n=(i.width-e.lineWidth)/2:"right"==i.align&&(n=i.width-e.lineWidth)),e.data.forEach(function(t){t.x+=n,o._fillText(t)})})},t.prototype._fillText=function(t){var i=t.context,e=t.x,o=t.y,n=t.style;this.ctx.font=n.font,this.ctx.textAlign=n.align,this.ctx.textBaseline="bottom",this.ctx.fillStyle=n.color,this.ctx.fillText(i,e,o)},t.prototype._get=function(t,i,e,o){var n=e;if("string"==typeof e)if(-1!==e.indexOf(":")&&"pos"==o){var a=e.split(":");switch(a[0]){case"left":case"top":n=+a[1].replace("px","");break;case"right":case"bottom":n=t-+a[1].replace("px","")-i}}else n=-1!==e.indexOf("px")?+e.replace("px",""):-1!==e.indexOf("%")?"crop"==o?i*+e.replace("%","")/100:t*+e.replace("%","")/100:"center"==e?(t-i)/2:+e;return Math.round(n)},t.prototype.draw=function(t){var i=this,o=void 0,n={type:"png",quality:.9,callback:function(){}};return"function"==typeof t?n.callback=t:(n=e.extend(n,t),"jpg"==n.type&&(n.type="jpeg")),this.end=function(){setTimeout(function(){o=i.canvas.toDataURL("image/"+n.type,n.quality),n.callback(o)},0)},this._next(),this},t.prototype._next=function(){this.queue.length>0?this.queue.shift()():this.end()},t});
//# sourceMappingURL=mcanvas.min.js.map
